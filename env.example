# ============================================================================
# NOTIFICATION SYSTEM - ENVIRONMENT CONFIGURATION
# ============================================================================
#
# Copy this file to .env and update with your actual values.
#
# Quick Start:
#   1. cp env.example .env
#   2. docker compose up -d
#   3. npm run db:migrate && npm run seed:all
#   4. npm run start:dev
#
# ============================================================================

# ============================================================================
# APPLICATION CONFIGURATION
# ============================================================================

NODE_ENV=development
PORT=3000
HOST=localhost
SERVICE_NAME=notification-system

# ============================================================================
# DATABASE CONFIGURATION
# ============================================================================

DATABASE_URL=postgresql://notification:notification@localhost:5432/notification_db
DB_POOL_MIN=2
DB_POOL_MAX=10

# ============================================================================
# REDIS CONFIGURATION
# ============================================================================

REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
REDIS_KEY_PREFIX=notification:

# ============================================================================
# KEYCLOAK AUTHENTICATION
# ============================================================================

KEYCLOAK_REALM=notification-realm
KEYCLOAK_SERVER_URL=http://localhost:8080
KEYCLOAK_USER_CLIENT_ID=notification-client
KEYCLOAK_SERVICE_CLIENT_ID=notification-service
KEYCLOAK_SERVICE_CLIENT_SECRET=your-service-client-secret-here
KEYCLOAK_ADMIN_CLIENT_ID=admin-cli
KEYCLOAK_ADMIN_USERNAME=admin
KEYCLOAK_ADMIN_PASSWORD=admin

# ============================================================================
# KAFKA EVENT BUS
# ============================================================================

KAFKA_BROKERS=localhost:9092
KAFKA_CLIENT_ID=notification-service
KAFKA_CONSUMER_GROUP_ID=notification-service-group

# Kafka Topics
KAFKA_TOPIC_ORDER_CREATED=order.created
KAFKA_TOPIC_ORDER_SHIPPED=order.shipped
KAFKA_TOPIC_PAYMENT_COMPLETED=payment.completed
KAFKA_TOPIC_PAYMENT_FAILED=payment.failed
KAFKA_TOPIC_USER_REGISTERED=user.registered
KAFKA_TOPIC_USER_PASSWORD_RESET=user.password-reset
KAFKA_TOPIC_NOTIFICATION_QUEUED=notification.queued
KAFKA_TOPIC_NOTIFICATION_SENT=notification.sent
KAFKA_TOPIC_NOTIFICATION_DELIVERED=notification.delivered
KAFKA_TOPIC_NOTIFICATION_FAILED=notification.failed
KAFKA_TOPIC_NOTIFICATION_READ=notification.read

# ============================================================================
# GRPC CONFIGURATION (optional - for microservices mode)
# ============================================================================

GRPC_ENABLED=false
GRPC_PORT=5001
GRPC_NOTIFICATION_SERVICE_URL=localhost:5001
GRPC_TEMPLATE_SERVICE_URL=localhost:5002
GRPC_TENANT_SERVICE_URL=localhost:5003

# ============================================================================
# GRAPHQL CONFIGURATION (optional - disabled until resolvers implemented)
# ============================================================================

GRAPHQL_ENABLED=false
GRAPHQL_PLAYGROUND=true
GRAPHQL_INTROSPECTION=true
GRAPHQL_SUBSCRIPTIONS=true

# ============================================================================
# USER SERVICE (optional - for user enrichment)
# ============================================================================

USER_SERVICE_URL=http://localhost:3001
USER_SERVICE_TIMEOUT=5000
USER_SERVICE_RETRY_ATTEMPTS=3
USER_SERVICE_RETRY_DELAY=1000
USER_SERVICE_CACHE_TTL=300

# ============================================================================
# MESSAGE QUEUE CONFIGURATION
# ============================================================================

# Queue Concurrency (workers per channel)
QUEUE_CONCURRENCY_EMAIL=5
QUEUE_CONCURRENCY_SMS=10
QUEUE_CONCURRENCY_FCM=20
QUEUE_CONCURRENCY_WHATSAPP=5
QUEUE_CONCURRENCY_DATABASE=50

# Queue Retry Configuration
QUEUE_RETRY_ATTEMPTS=3
QUEUE_RETRY_DELAY=2000

# Queue Cleanup
QUEUE_REMOVE_COMPLETE_AGE=86400
QUEUE_REMOVE_COMPLETE_COUNT=1000
QUEUE_REMOVE_FAIL_AGE=604800

# ============================================================================
# NOTIFICATION CHANNEL PROVIDERS
# ============================================================================

# Default Provider Selection
EMAIL_DEFAULT_PROVIDER=sendgrid
SMS_DEFAULT_PROVIDER=twilio
FCM_DEFAULT_PROVIDER=firebase
WHATSAPP_DEFAULT_PROVIDER=whatsapp-business

# --- Email Providers ---

# SendGrid
EMAIL_SENDGRID_API_KEY=SG.your-sendgrid-api-key-here
EMAIL_SENDGRID_FROM_EMAIL=noreply@yourdomain.com
EMAIL_SENDGRID_FROM_NAME=Your Company Name
EMAIL_SENDGRID_ENABLED=true

# AWS SES (optional)
EMAIL_SES_REGION=us-east-1
EMAIL_SES_ACCESS_KEY_ID=
EMAIL_SES_SECRET_ACCESS_KEY=
EMAIL_SES_FROM_EMAIL=noreply@yourdomain.com
EMAIL_SES_FROM_NAME=Your Company Name
EMAIL_SES_ENABLED=false

# Mailgun (optional)
EMAIL_MAILGUN_API_KEY=
EMAIL_MAILGUN_DOMAIN=yourdomain.com
EMAIL_MAILGUN_FROM_EMAIL=noreply@yourdomain.com
EMAIL_MAILGUN_FROM_NAME=Your Company Name
EMAIL_MAILGUN_ENABLED=false

# --- SMS Providers ---

# Twilio
SMS_TWILIO_ACCOUNT_SID=ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
SMS_TWILIO_AUTH_TOKEN=your-twilio-auth-token-here
SMS_TWILIO_FROM_PHONE=+1234567890
SMS_TWILIO_ENABLED=true

# AWS SNS (optional)
SMS_SNS_REGION=us-east-1
SMS_SNS_ACCESS_KEY_ID=
SMS_SNS_SECRET_ACCESS_KEY=
SMS_SNS_ENABLED=false

# --- Push Notification Providers ---

# Firebase Cloud Messaging (FCM)
FCM_PROJECT_ID=your-firebase-project-id
FCM_PRIVATE_KEY=your-firebase-private-key-base64-or-path
FCM_CLIENT_EMAIL=firebase-adminsdk-xxxxx@your-project.iam.gserviceaccount.com
FCM_ENABLED=true

# Apple Push Notification (APN) - optional
APN_KEY_ID=
APN_TEAM_ID=
APN_BUNDLE_ID=
APN_PRIVATE_KEY=
APN_PRODUCTION=false
APN_ENABLED=false

# --- WhatsApp Providers ---

# WhatsApp Business API
WHATSAPP_BUSINESS_ACCOUNT_ID=
WHATSAPP_PHONE_NUMBER_ID=
WHATSAPP_ACCESS_TOKEN=
WHATSAPP_ENABLED=true

# WPPConnect Provider
# WPPConnect WhatsApp Web client for multi-tenant messaging
# Docs: https://wppconnect.io/docs/tutorial/basics/creating-client
WHATSAPP_WPPCONNECT_ENABLED=false
WHATSAPP_WPPCONNECT_SESSION_NAME=notification-service
WHATSAPP_WPPCONNECT_AUTO_CLOSE=60000
WHATSAPP_WPPCONNECT_QR_TIMEOUT=60000
WHATSAPP_WPPCONNECT_USE_CHROME=true
WHATSAPP_WPPCONNECT_DISABLE_WELCOME=true
WHATSAPP_WPPCONNECT_TOKEN_STORE=file
WHATSAPP_WPPCONNECT_TOKEN_FOLDER=./tokens/wppconnect

# ============================================================================
# WEBSOCKET CONFIGURATION
# ============================================================================

WEBSOCKET_CORS_ORIGIN=*
WEBSOCKET_PING_INTERVAL=25000
WEBSOCKET_PING_TIMEOUT=60000

# ============================================================================
# SECURITY CONFIGURATION
# ============================================================================

# Encryption (for encrypting provider credentials in database)
ENCRYPTION_KEY=change-this-to-a-secure-32-character-key-minimum-length-required

# Rate Limiting
RATE_LIMIT_WINDOW=60000
RATE_LIMIT_MAX=100

# ============================================================================
# LOGGING CONFIGURATION
# ============================================================================

LOG_LEVEL=info
LOG_FORMAT=json
LOG_ENABLE_CONSOLE=true
LOG_ENABLE_FILE=false
LOG_FILE_PATH=./logs

# ============================================================================
# OBSERVABILITY & MONITORING CONFIGURATION
# ============================================================================

# Prometheus Metrics
OBSERVABILITY_PROMETHEUS_ENABLED=true
PROMETHEUS_METRICS_PATH=/metrics
PROMETHEUS_METRICS_PORT=3000

# Cloud Prometheus Configuration (for remote Prometheus servers)
# Use this when connecting to cloud-hosted Prometheus (e.g., Grafana Cloud, AWS AMP)
PROMETHEUS_REMOTE_WRITE_ENABLED=false
PROMETHEUS_REMOTE_WRITE_URL=https://your-prometheus-endpoint/api/prom/push
PROMETHEUS_REMOTE_WRITE_USERNAME=
PROMETHEUS_REMOTE_WRITE_PASSWORD=
# For bearer token authentication (alternative to username/password)
PROMETHEUS_REMOTE_WRITE_BEARER_TOKEN=

# Grafana Configuration (for cloud-hosted Grafana)
GRAFANA_ENABLED=false
GRAFANA_URL=https://your-grafana-instance.grafana.net
GRAFANA_API_KEY=
GRAFANA_DASHBOARD_UID=notification-system-comprehensive

# Metrics Collection Settings
METRICS_DEFAULT_LABELS_ENABLED=true
METRICS_COLLECT_DEFAULT_METRICS=true
METRICS_PREFIX=notification_system_

# Alert Manager Configuration (optional)
ALERTMANAGER_ENABLED=false
ALERTMANAGER_URL=http://localhost:9093
ALERTMANAGER_WEBHOOK_URL=

# Distributed Tracing (Jaeger)
OBSERVABILITY_TRACING_ENABLED=false
JAEGER_ENDPOINT=http://localhost:14268/api/traces
JAEGER_AGENT_HOST=localhost
JAEGER_AGENT_PORT=6831
JAEGER_SAMPLER_TYPE=probabilistic
JAEGER_SAMPLER_PARAM=0.1

# ELK Stack / Elasticsearch
OBSERVABILITY_ELK_ENABLED=false
ELASTICSEARCH_NODE=http://localhost:9200
ELASTICSEARCH_USERNAME=
ELASTICSEARCH_PASSWORD=
ELASTICSEARCH_INDEX_PREFIX=notification-logs

# ============================================================================
# RESILIENCE PATTERNS CONFIGURATION
# ============================================================================

# Circuit Breaker
CIRCUIT_BREAKER_ENABLED=true
CIRCUIT_BREAKER_FAILURE_THRESHOLD=5
CIRCUIT_BREAKER_SUCCESS_THRESHOLD=2
CIRCUIT_BREAKER_TIMEOUT=30000
CIRCUIT_BREAKER_RESET_TIMEOUT=60000

# Retry Policy
RETRY_ENABLED=true
RETRY_MAX_ATTEMPTS=3
RETRY_INITIAL_DELAY=1000
RETRY_MAX_DELAY=30000
RETRY_BACKOFF_MULTIPLIER=2

# Bulkhead (limit concurrent requests)
BULKHEAD_ENABLED=true
BULKHEAD_MAX_CONCURRENT=10

# ============================================================================
# SEEDING CONFIGURATION
# ============================================================================

# Enable/disable automatic seeding on startup
SEED_ENABLED=true
SEED_RESET_ON_START=false

# Control what gets seeded
SEED_ADMIN_USERS=true
SEED_TEST_USERS=true
SEED_SERVICE_ACCOUNTS=true
SEED_TENANTS=true
SEED_TEMPLATES=true
SEED_CATEGORIES=true
SEED_PROVIDERS=true

# Keycloak Seeding
SEED_KEYCLOAK=true

# ============================================================================
# PRODUCTION SETTINGS (uncomment for production)
# ============================================================================

# NODE_ENV=production
# PORT=3000
# HOST=0.0.0.0
# LOG_LEVEL=warn
# LOG_FORMAT=json
# GRAPHQL_PLAYGROUND=false
# GRAPHQL_INTROSPECTION=false
# SEED_ENABLED=false
# SEED_RESET_ON_START=false
# REDIS_PASSWORD=your-secure-redis-password
# RATE_LIMIT_MAX=50
# ENCRYPTION_KEY=generate-a-secure-32-byte-key-with-openssl
# OBSERVABILITY_PROMETHEUS_ENABLED=true
# OBSERVABILITY_TRACING_ENABLED=true
# OBSERVABILITY_ELK_ENABLED=true

# ============================================================================
# NOTES & QUICK START GUIDE
# ============================================================================
# 
# 1. Getting Started (Development):
#    - Copy this file: cp env.example .env
#    - Start infrastructure: docker compose up -d
#    - Wait for services: docker compose ps (check all are healthy)
#    - Run migrations: npm run db:migrate
#    - Seed database: npm run seed:all
#    - Start app: npm run start:dev
#    - Access Swagger: http://localhost:3000/api
#    - Access Kafka UI: http://localhost:8090
#    - Access Adminer: http://localhost:8081 (DB: postgres/notification/notification)
#    - Access Keycloak: http://localhost:8080 (admin/admin)
#
# 2. Database Configuration:
#    - Default credentials match docker-compose.yml
#    - Connection pool size: adjust DB_POOL_MIN and DB_POOL_MAX based on load
#    - For production: use connection string with SSL parameters
#
# 3. Provider Selection:
#    - Set default providers using *_DEFAULT_PROVIDER variables
#    - Individual providers can be enabled/disabled with _ENABLED flags
#    - Providers can be configured via environment (static) or database (dynamic)
#    - Provider credentials in database are encrypted using ENCRYPTION_KEY
#
# 4. Seeding Configuration:
#    - SEED_ENABLED=true runs seeds on app startup
#    - SEED_RESET_ON_START=true resets DB before seeding (DANGER - dev only!)
#    - Individual seed controls: SEED_TENANTS, SEED_TEMPLATES, etc.
#    - Manual seeding: npm run seed:all or npm run seed:database
#    - Keycloak seeding: npm run seed:keycloak
#
# 5. Security Best Practices:
#    - NEVER commit real credentials to version control
#    - Generate ENCRYPTION_KEY: openssl rand -base64 32
#    - Use secure passwords (min 16 chars, mixed case, numbers, symbols)
#    - Rotate ENCRYPTION_KEY and service secrets regularly
#    - Enable rate limiting in production
#    - Use HTTPS in production with proper SSL certificates
#
# 6. Provider Credentials:
#    - SendGrid: https://app.sendgrid.com/settings/api_keys
#    - Twilio: https://console.twilio.com/
#    - Firebase: https://console.firebase.google.com/ (download service account JSON)
#    - WhatsApp: https://business.facebook.com/ (requires business verification)
#    - AWS SES: https://aws.amazon.com/ses/ (verify email/domain first)
#    - AWS SNS: https://aws.amazon.com/sns/ (setup SMS spending limits)
#
# 7. Queue Configuration:
#    - Adjust QUEUE_CONCURRENCY_* based on your load and resources
#    - Higher concurrency = more parallel processing but more resources
#    - Recommended: Email 5-10, SMS 10-20, FCM 20-50, WhatsApp 5-10
#    - Monitor queue metrics via Prometheus (port 9090)
#
# 8. Observability & Monitoring:
#    - Metrics endpoint: http://localhost:3000/metrics (Prometheus format)
#    - Local Prometheus: docker compose up -d prometheus (access at http://localhost:9090)
#    - Local Grafana: docker compose up -d grafana (access at http://localhost:3001, admin/admin)
#    - Cloud Prometheus: Set PROMETHEUS_REMOTE_WRITE_ENABLED=true and configure URL/credentials
#    - Cloud Grafana: Set GRAFANA_ENABLED=true and configure GRAFANA_URL and GRAFANA_API_KEY
#    - Jaeger: Configure JAEGER_ENDPOINT for distributed tracing
#    - ELK Stack: Enable for centralized logging
#    
#    Cloud Setup Example (Grafana Cloud):
#      1. Get your Prometheus remote write endpoint from Grafana Cloud
#      2. Set PROMETHEUS_REMOTE_WRITE_ENABLED=true
#      3. Set PROMETHEUS_REMOTE_WRITE_URL=https://prometheus-prod-xx-xxx.grafana.net/api/prom/push
#      4. Set PROMETHEUS_REMOTE_WRITE_USERNAME=your-instance-id
#      5. Set PROMETHEUS_REMOTE_WRITE_PASSWORD=your-api-token
#      6. Your metrics endpoint (http://your-domain:3000/metrics) should be accessible to Prometheus
#      7. Configure Prometheus to scrape your metrics endpoint
#
# 9. Resilience Patterns:
#    - Circuit Breaker: Prevents cascading failures
#    - Retry Policy: Automatic retry with exponential backoff
#    - Bulkhead: Limits concurrent requests to prevent resource exhaustion
#    - All patterns can be enabled/disabled individually
#
# 10. Troubleshooting:
#    - Check logs: docker compose logs -f
#    - Check service health: docker compose ps
#    - Verify database: npm run db:studio (Drizzle Studio)
#    - View Kafka topics: http://localhost:8090 (Kafka UI)
#    - Enable detailed logs: LOG_LEVEL=debug
#
