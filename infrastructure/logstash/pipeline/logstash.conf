input {
  tcp {
    port => 5000
    codec => json
  }
  
  http {
    port => 8080
  }
}

filter {
  # Parse JSON logs
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
    }
  }

  # Add tags based on service
  if [service] {
    mutate {
      add_tag => ["${service}"]
    }
  }

  # Add metadata for indexing
  if [service] == "notification-system" {
    mutate {
      add_field => { "[@metadata][index]" => "notification-%{+YYYY.MM.dd}" }
    }
  } else {
    mutate {
      add_field => { "[@metadata][index]" => "logs-%{+YYYY.MM.dd}" }
    }
  }

  # Parse log level
  if [level] {
    mutate {
      uppercase => ["level"]
    }
  }

  # Parse timestamp
  if [timestamp] {
    date {
      match => ["timestamp", "ISO8601"]
      target => "@timestamp"
    }
  }

  # Remove unnecessary fields
  mutate {
    remove_field => ["host", "port"]
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "%{[@metadata][index]}"
    document_type => "_doc"
  }

  # Debug output (comment out in production)
  stdout {
    codec => rubydebug
  }
}
